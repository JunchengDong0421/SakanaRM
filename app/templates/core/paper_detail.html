{% extends 'base.html' %}

{% block title %}
    Paper Detail - {{ paper.id }}
{% endblock %}

{% block content %}
    <h2>PID: {{ paper.id }}</h2>
    <h2>Title: {{ paper.title }}</h2>
    <h2>Owner: {{ paper.owner }}</h2>
    <h2>Tags:
        {% for tag in paper.tags.all %}
            <p style="color: grey"> #{{ tag.name }} &nbsp;&nbsp; </p>
        {% endfor %}
    </h2>
    <br>
    <a id="back" href="#">Go Back</a><br>
    <a href="{% url 'core:index' %}" target="_blank">Homepage</a><br>
    <a href="{% url 'core:upload-paper-page' %}" target="_blank">Go to upload</a><br>
    <a href="{% url 'core:process-paper-page' %}" target="_blank">Go to process</a><br>
    <br>

    {% if paper.owner.id != request.session.uid %}
        <h2><em>You are not the owner! No actions available</em></h2>
    {% else %}
        <h2><em>Actions</em></h2>
        <hr>
        {% if paper.file_path %}
            <h3>Add (merge) tags to paper</h3>
            <form id="add-tags-form" method="post" action="{% url 'core:add-tags' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <label>Enter tags:
                    <input id="tags" type="text" name="tags"/>
                    (separate with ;)
                </label>
                <input type="hidden" name="pid" value="{{ paper.id }}">
                <p id="confirm" style="color: green"></p>
                <br>
                <button type="submit">Add Tags</button>
            </form>
            <p id="err-msg-1" style="color: red"></p>

            <hr>
            <h3 style="color: red">Delete paper</h3>
            <button id="delete">Delete</button>
            <p id="err-msg-2" style="color: red"></p>
            <p id="del-info" style="color:green;"></p>
        {% else %}
            <i style="color: red; font-size: large">Paper not ready yet. Please wait until it is fully uploaded or
                contact the administrator for help.</i>
        {% endif %}
    {% endif %}

    <script>
        var deleteURL = "{% url 'core:delete-paper' %}";

        $(document).ready(() => {
            // Show tag names on input
            $('#tags').on("change", () => {
                const input = $('#tags').val();
                if (input.length > 0) {
                    const splitValues = input.split(';').map(value => value.trim());
                    $("#confirm").text("Confirmation: " + splitValues.join(', '));
                } else {
                    $("#confirm").text("");
                }
            });

            // Submit add tags form
            $('#add-tags-form').submit(e => {
                e.preventDefault();
                const form = $('#add-tags-form');
                var formData = new FormData(form[0]);
                $.ajax({
                    url: form.attr('action'),
                    type: form.attr('method'),
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: res => {
                        if (res.status === 0) {
                            location.reload();
                        } else {
                            $('#err-msg-1').text("Error: " + res.err_msg);
                        }
                    }
                });
            });

            // Delete event
            $("#delete").click(() => {
                $.ajax({
                    url: deleteURL,
                    type: 'POST',
                    data: {
                        "pid": '{{ paper.id }}',
                        "csrfmiddlewaretoken": '{{ csrf_token }}'
                    },
                    success: res => {
                        if (res.status === 0) {
                            $("#del-info").text('');
                            alert("Delete successful!")
                            location.href = "{% url 'core:index' %}";
                        } else {
                            $('#err-msg-2').text("Error: " + res.err_msg);
                        }
                    }
                });
                $("#del-info").text("Deleting ... Please wait");
            });

            // go back or redirect to home link
            $("#back").click(e => {
                e.preventDefault();
                if (window.history.length > 1) {
                    window.history.back();
                } else {
                    window.location.href = "{% url 'core:index' %}";
                }
            });
        })
    </script>
{% endblock %}